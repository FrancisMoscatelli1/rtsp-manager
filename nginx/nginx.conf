# Cargar el módulo RTMP
load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

worker_processes auto;
events {
    worker_connections 1024;
}

# Configuración RTMP
rtmp {
    server {
        listen 1935;
        chunk_size 4000;

        # Aplicación principal para recibir streams
        application live {
            live on;

            # Permitir publicación desde cualquier IP
            allow publish all;
            allow play all;

            # Configuración para DASH
            dash on;
            dash_path /tmp/dash;
            dash_fragment 5s;
            dash_playlist_length 10s;
            dash_nested on;
            dash_cleanup on;

            # Configuración para HLS
            hls on;
            hls_path /tmp/hls;
            hls_fragment 5s;
            hls_playlist_length 10s;
            hls_continuous on;
            hls_cleanup on;
            hls_nested on;

            # Configuraciones adicionales
            drop_idle_publisher 10s;
        }
    }
}

# Configuración HTTP
http {
    sendfile off;
    tcp_nopush on;
    directio 512;
    default_type application/octet-stream;

    server {
        listen 80;

        # Configurar CORS para permitir acceso desde cualquier origen
        location / {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            add_header 'Access-Control-Allow-Headers' 'Range';

            # Para preflight requests
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            root /usr/share/nginx/html;
            index index.html;
        }

        # Servir archivos DASH
        location /dash {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            add_header 'Access-Control-Allow-Headers' 'Range';

            # Para preflight requests
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            alias /tmp/dash;

            # Tipos MIME para DASH
            location ~ \.mpd$ {
                add_header 'Cache-Control' 'no-cache' always;
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Content-Type' 'application/dash+xml';
            }

            location ~ \.m4v$ {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Content-Type' 'video/mp4';
            }

            location ~ \.m4a$ {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Content-Type' 'audio/mp4';
            }

            location ~ \.m4s$ {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Content-Type' 'video/iso.segment';
            }
        }

        # Servir archivos HLS (alternativa)
        location /hls {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            add_header 'Access-Control-Allow-Headers' 'Range';

            alias /tmp/hls;

            # Tipos MIME para HLS
            location ~ \.m3u8$ {
                add_header 'Cache-Control' 'no-cache' always;
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Content-Type' 'application/vnd.apple.mpegurl';
            }

            location ~ \.ts$ {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Content-Type' 'video/mp2t';
            }
        }

        # Estadísticas RTMP (opcional)
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
            add_header 'Access-Control-Allow-Origin' '*' always;
        }

        location /stat.xsl {
            root /usr/share/nginx/html;
        }

        # Control de RTMP (opcional)
        location /control {
            rtmp_control all;
            add_header 'Access-Control-Allow-Origin' '*' always;
        }
    }
}
